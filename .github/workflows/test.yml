name: Test
on: [push, pull_request]
jobs:
  test:
    name: "rake test"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: "/home/runner/work/agent-payload/agent-payload/go/src/github.com/DataDog/agent-payload"
    steps:
    - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0
      with:
        path: go/src/github.com/DataDog/agent-payload
    - name: "Install ruby"
      uses: ruby/setup-ruby@ab177d40ee5483edb974554986f56b33477e21d0 # v1.265.0
      with:
        ruby-version: head
    - name: Install go
      uses: actions/setup-go@be3c94b385c4f180051c996d336f57a34c397495 # v3.6.1
      with:
        go-version-file: "/home/runner/work/agent-payload/agent-payload/go/src/github.com/DataDog/agent-payload/go.mod"
    - run: rake test
      env:
        GOPATH: "/home/runner/work/agent-payload/agent-payload/go"

  codegen:
    name: "rake codegen"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: "/home/runner/work/agent-payload/agent-payload/go/src/github.com/DataDog/agent-payload"
    steps:
    - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0
      with:
        path: go/src/github.com/DataDog/agent-payload
    - name: "Install ruby"
      uses: ruby/setup-ruby@ab177d40ee5483edb974554986f56b33477e21d0 # v1.265.0
      with:
        ruby-version: head
    - name: Install go
      uses: actions/setup-go@be3c94b385c4f180051c996d336f57a34c397495 # v3.6.1
      with:
        go-version-file: "/home/runner/work/agent-payload/agent-payload/go/src/github.com/DataDog/agent-payload/go.mod"
    - run: rake codegen
      env:
        GOPATH: "/home/runner/work/agent-payload/agent-payload/go"
    - name: Check for diffs
      run: git diff --exit-code
