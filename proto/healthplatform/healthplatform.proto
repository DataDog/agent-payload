syntax = "proto3";

package datadog.healthplatform;

option go_package = "github.com/DataDog/agent-payload/v5/healthplatform";

import "google/protobuf/struct.proto";

// IssueState represents the lifecycle state of an issue
enum IssueState {
    ISSUE_STATE_UNSPECIFIED = 0;
    ISSUE_STATE_NEW = 1;
    ISSUE_STATE_ONGOING = 2;
    ISSUE_STATE_RESOLVED = 3;
}

// Issue represents an individual issue to be reported
message Issue {
    // ID is the unique identifier for the issue
    string id = 1;
    // IssueName is the human-readable name for the issue
    string issue_name = 2;
    // Title is the short title/headline of the issue
    string title = 3;
    // Description is the detailed description of the issue
    string description = 4;
    // Category indicates the type/category of the issue (e.g., permissions, connectivity, etc.)
    string category = 5;
    // Location indicates where the issue occurred (e.g., core agent, log agent, etc.)
    string location = 6;
    // Severity indicates the impact level of the issue
    string severity = 7;
    // DetectedAt is the timestamp when the issue was detected
    string detected_at = 8;
    // Source is the sub-agent or product that reported the issue
    // (e.g., "logs", "apm", "error-tracking", "network-monitoring")
    string source = 9;
    // Extra is optional complementary structured information
    google.protobuf.Struct extra = 10;
    // Remediation provides steps to fix the issue
    Remediation remediation = 11;
    // Tags are additional labels for the issue
    repeated string tags = 12;
    // PersistedIssue tracks the lifecycle state of the issue
    PersistedIssue persisted_issue = 13;
}

// Remediation represents remediation steps for an issue
message Remediation {
    // Summary is a brief description of the remediation
    string summary = 1;
    // Steps are the ordered steps to fix the issue
    repeated RemediationStep steps = 2;
    // Script is an automated script to fix the issue
    Script script = 3;
}

// RemediationStep represents a single remediation step
message RemediationStep {
    // Order is the sequence number of the step
    int32 order = 1;
    // Text is the description of what to do
    string text = 2;
}

// Script represents a remediation script
message Script {
    // Language is the scripting language (e.g., bash, powershell, python, javascript)
    string language = 1;
    // LanguageVersion is the required interpreter version (e.g., "3.8+" for Python, ">=14" for Node.js)
    string language_version = 2;
    // Filename is the suggested filename for the script
    string filename = 3;
    // RequiresRoot indicates if the script needs root privileges
    bool requires_root = 4;
    // Content is the actual script content
    string content = 5;
}

// HostInfo represents the host information in the health report
message HostInfo {
    // Hostname is the hostname of the reporting host
    string hostname = 1;
    // AgentVersion is the version of the agent
    optional string agent_version = 2;
    // ParIDs are the partition/organization IDs
    repeated string par_ids = 3;
}

// HealthReport represents the formatted health report structure sent to Datadog intake
message HealthReport {
    // SchemaVersion is the version of the schema
    string schema_version = 1;
    // EventType is the type of event
    string event_type = 2;
    // EmittedAt is the timestamp when the report was emitted
    string emitted_at = 3;
    // Host contains host information
    HostInfo host = 4;
    // Issues is a map of check IDs to their issues
    map<string, Issue> issues = 5;
    // Service is the service that detected the issue (datadog-agent, cluster-agent, backend service)
    string service = 6;
}

// JSONAPIMeta represents metadata in JSON:API format
message JSONAPIMeta {
    // SchemaVersion is the version of the schema
    string schema_version = 1;
    // EventType is the type of event
    string event_type = 2;
    // EmittedAt is the timestamp when the report was emitted
    string emitted_at = 3;
}

// JSONAPIResponse represents the JSON:API wrapper for health reports
message JSONAPIResponse {
    // Data contains the health report
    HealthReport data = 1;
    // Meta contains optional metadata
    JSONAPIMeta meta = 2;
}

// IssueReport represents a lightweight issue report from an integration
// The health platform fills in all metadata and remediation based on the issue ID
message IssueReport {
    // IssueID is the unique identifier for the type of issue
    // The health platform registry uses this to look up all issue details
    string issue_id = 1;
    // Context provides variables for filling in templates
    // (e.g., {"dockerDir": "/var/lib/docker", "os": "linux"})
    map<string, string> context = 2;
    // Tags are optional additional labels for filtering and categorization
    // These are appended to the default tags from the registry
    repeated string tags = 3;
}

// PersistedIssue tracks the lifecycle state of a single issue
message PersistedIssue {
    // State is the current lifecycle state
    IssueState state = 1;
    // FirstSeen is the timestamp when the issue was first detected
    string first_seen = 2;
    // LastSeen is the timestamp when the issue was last observed
    string last_seen = 3;
    // ResolvedAt is the timestamp when the issue was resolved
    optional string resolved_at = 4;
}

